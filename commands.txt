# ArgoCD with Helm
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update
helm install argo-cd argo/argo-cd --create-namespace --namespace argocd --values resources/values.yaml

# Retrieve ArgoCD first password
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

# Port foward ArgoCD to 8080
kubectl port-forward service/argo-cd-argocd-server -n argocd 8080:443

# Expose kong to http
kubectl -n argocd patch deployment argo-cd-argocd-server --type json \
    -p='[ { "op": "replace", "path":"/spec/template/spec/containers/0/command","value": ["argocd-server","--staticassets","/shared/app","--repo-server","argo-cd-argocd-repo-server:8081","--dex-server","http://argo-cd-argocd-dex-server:5556","--logformat","text","--loglevel","info","--redis","argo-cd-argocd-redis:6379","--insecure"] }]'

# Deploy kong prometheus plugin
kubectl apply -f resource/plugins/kong/prometheus.yaml

# Deploy kong rate limiting plugin on foo-bar namespace
kubectl apply -n foo-bar -f resource/plugins/kong/rate-limiting.yaml